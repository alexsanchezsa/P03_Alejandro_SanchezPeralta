name: "CD #8 - El Guardian de Secretos"

# Se activa manualmente
on:
  workflow_dispatch:

jobs:
  desplegar:
    runs-on: ubuntu-latest

    # Inyectar secretos como variables de entorno (NADIE puede verlos en el codigo)
    env:
      DB_HOST: ${{ secrets.DB_HOST }}
      DB_PORT: ${{ secrets.DB_PORT }}
      DB_NAME: ${{ secrets.DB_NAME }}
      DB_USERNAME: ${{ secrets.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}

    steps:
      - name: Descargar codigo fuente
        uses: actions/checkout@v4

      - name: Configurar JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Compilar y empaquetar con credenciales seguras
        run: |
          mvn -B clean package -DskipTests \
            -Dspring.datasource.url=jdbc:mysql://${DB_HOST}:${DB_PORT}/${DB_NAME} \
            -Dspring.datasource.username=${DB_USERNAME} \
            -Dspring.datasource.password=${DB_PASSWORD}

      - name: Verificar que los secretos no se exponen
        run: |
          echo "Despliegue con credenciales seguras completado."
          echo "Las credenciales de la BD estan protegidas por GitHub Secrets."
          echo "Host de BD configurado: [PROTEGIDO]"
