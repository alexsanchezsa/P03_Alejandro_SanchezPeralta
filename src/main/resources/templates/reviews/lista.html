<!DOCTYPE html>
<!-- Muestra todas las reviews en una tabla con opciones de editar y eliminar. -->
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<head>
    <title>Reviews</title>
</head>
<body>
<section layout:fragment="contenido">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item active">Gestión</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0">
                <i class="bi bi-star-fill text-primary me-2"></i>Reviews
                <span class="badge bg-secondary ms-2" th:text="${totalElementos}">0</span>
            </h1>
        </div>
        <a class="btn btn-primary" th:href="@{/reviews/nuevo}">
            <i class="bi bi-plus-circle me-1"></i>Nueva review
        </a>
    </div>

    <!-- Barra de búsqueda -->
    <div class="card shadow-sm mb-4">
        <div class="card-body py-3">
            <form th:action="@{/reviews}" method="get" class="row g-3 align-items-center">
                <div class="col-md-8 col-lg-6">
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" name="busqueda" class="form-control" 
                               placeholder="Buscar por descripción..."
                               th:value="${busqueda}">
                        <button class="btn btn-primary" type="submit">
                            Buscar
                        </button>
                        <a th:if="${busqueda}" class="btn btn-outline-secondary" th:href="@{/reviews}">
                            <i class="bi bi-x-lg"></i> Limpiar
                        </a>
                    </div>
                </div>
                <div class="col-md-4 col-lg-6 text-md-end">
                    <small class="text-muted" th:if="${busqueda}">
                        <i class="bi bi-funnel-fill me-1"></i>
                        Mostrando resultados para: "<span th:text="${busqueda}"></span>"
                    </small>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle">
                    <thead class="table-light">
                    <tr>
                        <th scope="col" style="width: 60px;">#</th>
                        <th scope="col">Cliente</th>
                        <th scope="col">Descripción</th>
                        <th scope="col">Valoración</th>
                        <th scope="col" class="text-end" style="width: 120px;">Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- No hay reviews -->
                    <tr th:if="${#lists.isEmpty(reviews)}">
                        <td colspan="5" class="text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2 mb-0" th:if="${busqueda}">No se encontraron reviews para "<span th:text="${busqueda}"></span>"</p>
                            <p class="text-muted mt-2 mb-0" th:unless="${busqueda}">No hay reviews registradas.</p>
                            <a th:href="@{/reviews/nuevo}" class="btn btn-outline-primary btn-sm mt-3" th:unless="${busqueda}">
                                <i class="bi bi-plus-circle me-1"></i>Añadir primera review
                            </a>
                            <a th:href="@{/reviews}" class="btn btn-outline-secondary btn-sm mt-3" th:if="${busqueda}">
                                <i class="bi bi-arrow-left me-1"></i>Ver todas las reviews
                            </a>
                        </td>
                    </tr>
                    <!-- Lista de reviews -->
                    <tr th:each="review : ${reviews}">
                        <th scope="row" th:text="${review.id}">1</th>
                        <td>
                            <span th:if="${review.cliente}" th:text="${review.cliente.nombre}">Cliente</span>
                            <span th:unless="${review.cliente}" class="text-muted">Sin cliente</span>
                        </td>
                        <td>
                            <span th:text="${#strings.abbreviate(review.descripcion, 100)}">Descripción</span>
                        </td>
                        <td>
                            <div class="text-warning">
                                <i th:each="i : ${#numbers.sequence(1, review.valoracion)}" class="bi bi-star-fill"></i>
                                <i th:each="i : ${#numbers.sequence(review.valoracion + 1, 5)}" class="bi bi-star"></i>
                                <span class="text-muted ms-1" th:text="${review.valoracion} + '/5'">5/5</span>
                            </div>
                        </td>
                        <td class="text-end">
                            <!-- Botón editar -->
                            <a class="btn btn-outline-primary btn-sm me-1" th:href="@{|/reviews/editar/${review.id}|}" 
                               title="Editar review">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <!-- Botón eliminar -->
                            <button class="btn btn-outline-danger btn-sm" type="button" 
                                    title="Eliminar review"
                                    data-bs-toggle="modal" 
                                    th:data-bs-target="${'#eliminarModal' + review.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Paginación -->
        <div class="card-footer bg-white" th:if="${totalPaginas > 1}">
            <nav aria-label="Navegación de páginas">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    <!-- Primera página -->
                    <li class="page-item" th:classappend="${paginaActual == 0} ? 'disabled'">
                        <a class="page-link" th:href="@{/reviews(page=0, busqueda=${busqueda})}" aria-label="Primera">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    <!-- Anterior -->
                    <li class="page-item" th:classappend="${paginaActual == 0} ? 'disabled'">
                        <a class="page-link" th:href="@{/reviews(page=${paginaActual - 1}, busqueda=${busqueda})}" aria-label="Anterior">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    <!-- Números de página -->
                    <th:block th:with="inicio=${paginaActual > 2 ? paginaActual - 2 : 0}, 
                                       fin=${(paginaActual + 2) < totalPaginas ? paginaActual + 2 : totalPaginas - 1}">
                        <li class="page-item" th:if="${inicio > 0}">
                            <span class="page-link disabled">...</span>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(inicio, fin)}" 
                            th:classappend="${i == paginaActual} ? 'active'">
                            <a class="page-link" th:href="@{/reviews(page=${i}, busqueda=${busqueda})}" th:text="${i + 1}">1</a>
                        </li>
                        <li class="page-item" th:if="${fin < totalPaginas - 1}">
                            <span class="page-link disabled">...</span>
                        </li>
                    </th:block>
                    <!-- Siguiente -->
                    <li class="page-item" th:classappend="${paginaActual >= totalPaginas - 1} ? 'disabled'">
                        <a class="page-link" th:href="@{/reviews(page=${paginaActual + 1}, busqueda=${busqueda})}" aria-label="Siguiente">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    <!-- Última página -->
                    <li class="page-item" th:classappend="${paginaActual >= totalPaginas - 1} ? 'disabled'">
                        <a class="page-link" th:href="@{/reviews(page=${totalPaginas - 1}, busqueda=${busqueda})}" aria-label="Última">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            <p class="text-center text-muted small mt-2 mb-0">
                Página <span th:text="${paginaActual + 1}">1</span> de <span th:text="${totalPaginas}">1</span>
                (<span th:text="${totalElementos}">0</span> registros)
            </p>
        </div>
    </div>
    
    <!-- Modales de confirmación para eliminar -->
    <div th:each="review : ${reviews}">
        <div class="modal fade" th:id="${'eliminarModal' + review.id}" tabindex="-1" 
             th:aria-labelledby="${'eliminarModalLabel' + review.id}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" th:id="${'eliminarModalLabel' + review.id}">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirmar eliminación
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-2">¿Estás seguro de que deseas eliminar la siguiente review?</p>
                        <div class="alert alert-light border mb-0">
                            <div class="text-warning mb-2">
                                <i th:each="i : ${#numbers.sequence(1, review.valoracion)}" class="bi bi-star-fill"></i>
                                <i th:each="i : ${#numbers.sequence(review.valoracion + 1, 5)}" class="bi bi-star"></i>
                            </div>
                            <p class="mb-1" th:text="${review.descripcion}">Descripción</p>
                            <small class="text-muted" th:if="${review.cliente}">
                                Cliente: <span th:text="${review.cliente.nombre}">Nombre</span>
                            </small>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg me-1"></i>Cancelar
                        </button>
                        <form th:action="@{|/reviews/eliminar/${review.id}|}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-trash me-1"></i>Eliminar
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
</body>
</html>
