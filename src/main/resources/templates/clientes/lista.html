<!DOCTYPE html>
<!-- Muestra todos los clientes en una tabla con opciones de editar y eliminar. -->
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout" layout:decorate="~{layout}">
<head>
    <title>Clientes</title>
</head>
<body>
<section layout:fragment="contenido">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb mb-1">
                    <li class="breadcrumb-item active">Gestión</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0">
                <i class="bi bi-people-fill text-primary me-2"></i>Clientes
                <span class="badge bg-secondary ms-2" th:text="${totalElementos}">0</span>
            </h1>
        </div>
        <a class="btn btn-primary" th:href="@{/clientes/nuevo}">
            <i class="bi bi-plus-circle me-1"></i>Nuevo cliente
        </a>
    </div>

    <!-- Barra de búsqueda -->
    <div class="card shadow-sm mb-4">
        <div class="card-body py-3">
            <form th:action="@{/clientes}" method="get" class="row g-3 align-items-center">
                <div class="col-md-8 col-lg-6">
                    <div class="input-group">
                        <span class="input-group-text bg-white">
                            <i class="bi bi-search text-muted"></i>
                        </span>
                        <input type="text" name="busqueda" class="form-control" 
                               placeholder="Buscar por nombre o género..."
                               th:value="${busqueda}">
                        <button class="btn btn-primary" type="submit">
                            Buscar
                        </button>
                        <a th:if="${busqueda}" class="btn btn-outline-secondary" th:href="@{/clientes}">
                            <i class="bi bi-x-lg"></i> Limpiar
                        </a>
                    </div>
                </div>
                <div class="col-md-4 col-lg-6 text-md-end">
                    <small class="text-muted" th:if="${busqueda}">
                        <i class="bi bi-funnel-fill me-1"></i>
                        Mostrando resultados para: "<span th:text="${busqueda}"></span>"
                    </small>
                </div>
            </form>
        </div>
    </div>

    <div class="card shadow-sm">
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-striped table-hover mb-0 align-middle">
                    <thead class="table-light">
                    <tr>
                        <th scope="col" style="width: 60px;">#</th>
                        <th scope="col">Nombre</th>
                        <th scope="col">Edad</th>
                        <th scope="col">Género</th>
                        <th scope="col">Intolerancia</th>
                        <th scope="col">Review</th>
                        <th scope="col" class="text-end" style="width: 120px;">Acciones</th>
                    </tr>
                    </thead>
                    <tbody>
                    <!-- No hay clientes -->
                    <tr th:if="${#lists.isEmpty(clientes)}">
                        <td colspan="7" class="text-center py-5">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2 mb-0" th:if="${busqueda}">No se encontraron clientes para "<span th:text="${busqueda}"></span>"</p>
                            <p class="text-muted mt-2 mb-0" th:unless="${busqueda}">No hay clientes registrados.</p>
                            <a th:href="@{/clientes/nuevo}" class="btn btn-outline-primary btn-sm mt-3" th:unless="${busqueda}">
                                <i class="bi bi-plus-circle me-1"></i>Añadir primer cliente
                            </a>
                            <a th:href="@{/clientes}" class="btn btn-outline-secondary btn-sm mt-3" th:if="${busqueda}">
                                <i class="bi bi-arrow-left me-1"></i>Ver todos los clientes
                            </a>
                        </td>
                    </tr>
                    <!-- Lista de clientes -->
                    <tr th:each="cliente : ${clientes}">
                        <th scope="row" th:text="${cliente.id}">1</th>
                        <td th:text="${cliente.nombre}">Nombre</td>
                        <td th:text="${cliente.edad}">25</td>
                        <td>
                            <span class="badge bg-info text-dark" th:text="${cliente.genero}">Género</span>
                        </td>
                        <td>
                            <span th:if="${cliente.intolerancia}" class="badge bg-warning text-dark" 
                                  th:title="${cliente.detalleIntolerancia}">
                                <i class="bi bi-exclamation-triangle-fill me-1"></i>Sí
                            </span>
                            <span th:unless="${cliente.intolerancia}" class="badge bg-success">No</span>
                        </td>
                        <td>
                            <span th:if="${cliente.review}" class="text-warning">
                                <i th:each="i : ${#numbers.sequence(1, cliente.review.valoracion)}" class="bi bi-star-fill"></i>
                                <i th:each="i : ${#numbers.sequence(cliente.review.valoracion + 1, 5)}" class="bi bi-star"></i>
                            </span>
                            <span th:unless="${cliente.review}" class="text-muted">Sin review</span>
                        </td>
                        <td class="text-end">
                            <!-- Botón editar -->
                            <a class="btn btn-outline-primary btn-sm me-1" th:href="@{|/clientes/editar/${cliente.id}|}" 
                               title="Editar cliente">
                                <i class="bi bi-pencil"></i>
                            </a>
                            <!-- Botón eliminar -->
                            <button class="btn btn-outline-danger btn-sm" type="button" 
                                    title="Eliminar cliente"
                                    data-bs-toggle="modal" 
                                    th:data-bs-target="${'#eliminarModal' + cliente.id}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                    </tbody>
                </table>
            </div>
        </div>
        
        <!-- Paginación -->
        <div class="card-footer bg-white" th:if="${totalPaginas > 1}">
            <nav aria-label="Navegación de páginas">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    <!-- Primera página -->
                    <li class="page-item" th:classappend="${paginaActual == 0} ? 'disabled'">
                        <a class="page-link" th:href="@{/clientes(page=0, busqueda=${busqueda})}" aria-label="Primera">
                            <i class="bi bi-chevron-double-left"></i>
                        </a>
                    </li>
                    <!-- Anterior -->
                    <li class="page-item" th:classappend="${paginaActual == 0} ? 'disabled'">
                        <a class="page-link" th:href="@{/clientes(page=${paginaActual - 1}, busqueda=${busqueda})}" aria-label="Anterior">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    <!-- Números de página -->
                    <th:block th:with="inicio=${paginaActual > 2 ? paginaActual - 2 : 0}, 
                                       fin=${(paginaActual + 2) < totalPaginas ? paginaActual + 2 : totalPaginas - 1}">
                        <li class="page-item" th:if="${inicio > 0}">
                            <span class="page-link disabled">...</span>
                        </li>
                        <li class="page-item" th:each="i : ${#numbers.sequence(inicio, fin)}" 
                            th:classappend="${i == paginaActual} ? 'active'">
                            <a class="page-link" th:href="@{/clientes(page=${i}, busqueda=${busqueda})}" th:text="${i + 1}">1</a>
                        </li>
                        <li class="page-item" th:if="${fin < totalPaginas - 1}">
                            <span class="page-link disabled">...</span>
                        </li>
                    </th:block>
                    <!-- Siguiente -->
                    <li class="page-item" th:classappend="${paginaActual >= totalPaginas - 1} ? 'disabled'">
                        <a class="page-link" th:href="@{/clientes(page=${paginaActual + 1}, busqueda=${busqueda})}" aria-label="Siguiente">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                    <!-- Última página -->
                    <li class="page-item" th:classappend="${paginaActual >= totalPaginas - 1} ? 'disabled'">
                        <a class="page-link" th:href="@{/clientes(page=${totalPaginas - 1}, busqueda=${busqueda})}" aria-label="Última">
                            <i class="bi bi-chevron-double-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
            <p class="text-center text-muted small mt-2 mb-0">
                Página <span th:text="${paginaActual + 1}">1</span> de <span th:text="${totalPaginas}">1</span>
                (<span th:text="${totalElementos}">0</span> registros)
            </p>
        </div>
    </div>
    
    <!-- Modales de confirmación para eliminar -->
    <div th:each="cliente : ${clientes}">
        <div class="modal fade" th:id="${'eliminarModal' + cliente.id}" tabindex="-1" 
             th:aria-labelledby="${'eliminarModalLabel' + cliente.id}" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header bg-danger text-white">
                        <h5 class="modal-title" th:id="${'eliminarModalLabel' + cliente.id}">
                            <i class="bi bi-exclamation-triangle-fill me-2"></i>Confirmar eliminación
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-2">¿Estás seguro de que deseas eliminar al siguiente cliente?</p>
                        <div class="alert alert-light border mb-0">
                            <strong th:text="${cliente.nombre}">Nombre</strong>
                            <br>
                            <small class="text-muted">
                                Edad: <span th:text="${cliente.edad}">0</span> | 
                                Género: <span th:text="${cliente.genero}">-</span>
                            </small>
                            <div th:if="${cliente.review}" class="mt-2">
                                <span class="badge bg-warning text-dark">
                                    <i class="bi bi-exclamation-circle me-1"></i>
                                    Este cliente tiene una review asociada que también será eliminada
                                </span>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg me-1"></i>Cancelar
                        </button>
                        <form th:action="@{|/clientes/eliminar/${cliente.id}|}" method="post" class="d-inline">
                            <button type="submit" class="btn btn-danger">
                                <i class="bi bi-trash me-1"></i>Eliminar
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
</body>
</html>
